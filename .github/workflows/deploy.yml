name: Deploy to Synology NAS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to NAS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.NAS_HOST }}
          username: ${{ secrets.NAS_USERNAME }}
          key: ${{ secrets.NAS_SSH_KEY }}
          port: ${{ secrets.NAS_PORT }}
          script: |
            cd ~/docker/RecommandStock
            echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
            echo "ğŸ” Git ìƒíƒœ í™•ì¸..."
            git status

            # upstream remote í™•ì¸ ë° ì¶”ê°€ (HTTPS)
            if ! git remote | grep -q "^upstream$"; then
              echo "âš™ï¸  upstream remote ì¶”ê°€ ì¤‘..."
              git remote add upstream https://github.com/leevelop-up/RecommandStock.git
            fi

            echo "ğŸ“¡ Git remote ëª©ë¡:"
            git remote -v

            echo "ğŸ”„ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
            git fetch upstream
            git reset --hard upstream/main

            echo "ğŸ“ í˜„ì¬ ì»¤ë°‹:"
            git log -1 --oneline

            echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆ ì¬ë¹Œë“œ ë° ì¬ì‹œì‘..."
            /usr/local/bin/docker-compose down
            /usr/local/bin/docker-compose up -d --build --force-recreate

            echo "âœ… ìë™ ë°°í¬ ì™„ë£Œ!"
            echo "ğŸ”— ë°°í¬ URL: http://leevelop.com:3000"
